<!DOCTYPE html>
<html>
<head>
  <title>TiffyAI Interface</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }

    /* Loading Screen with drop.gif behind Tiffy */
    #loadingScreen {
      position: absolute;
      top:0;left:0;
      width:100%;height:100%;
      background:#000 url("https://ipfs.io/ipfs/Qma3L2F7J9k5Q6n8D7g2V1W3p3Q2j3b4m6p9x4r5z7x8n") center/cover no-repeat;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:20000;
      transition: opacity 1s ease;
    }
    #loadingScreen img {
      width:200px;
      border-radius:50%;
      box-shadow:0 0 30px #00f0ff;
      margin-bottom:10px;
    }
    #loadingScreen h2, #loadingScreen p {
      font-family:sans-serif;
      text-align:center;
      margin:6px 0;
    }
    .glass-input {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 10px;
      border-radius: 8px;
      color: white;
      font-family: sans-serif;
      font-size: 16px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .glass-input::placeholder { color: rgba(255, 255, 255, 0.7); }
    .glass-input:focus { outline: none; border-color: #00f0ff; }

    /* Main UI */
    #mainUI {
      position: absolute;
      bottom: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      z-index: 1000;
    }

    #messageBox {
      width: 80%;
      max-width: 600px;
      margin-bottom: 10px;
    }
    #sendButton, #micButton {
      background: #00f0ff;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 8px;
      font-family: sans-serif;
      font-weight: bold;
      color: #000;
      box-shadow: 0 0 15px #00f0ff;
      margin-right: 10px;
    }
    #micButton {
      background: #f000ff;
      box-shadow: 0 0 15px #f000ff;
    }
    #micButton:hover {
      background: #ff4dff;
    }
    #messageBox:focus, #sendButton:focus, #micButton:focus { outline: none; }
    #messageBox, #sendButton, #micButton {
      transition: all 0.2s ease;
    }
    #messageBox:hover, #sendButton:hover, #micButton:hover {
      transform: scale(1.05);
    }

    #chat-history {
      position: absolute;
      top: 0;
      left: 0;
      width: 30%;
      height: 70%;
      padding: 20px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-family: sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }
    .chat-message.user {
      text-align: right;
      color: #00f0ff;
      font-weight: bold;
    }
    .chat-message.ai {
      text-align: left;
      color: #f000ff;
      font-style: italic;
    }
    #chat-history h3 {
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 10px;
    }
  </style>
</head>
<body>

  <div id="loadingScreen">
    <img src="https://ipfs.io/ipfs/QmfSg7Wc6X1Z8N7gC4p7R6p9t7p5M7q5R6w7q5w5q5p" alt="TiffyAI Logo">
    <h2>TiffyAI</h2>
    <p id="loadingStatus">Loading Tiffyverse...</p>
    <div id="loadingProgress" style="width: 200px; height: 10px; background: rgba(255, 255, 255, 0.2); border-radius: 5px; margin-top: 10px;">
      <div id="progressBar" style="width: 0%; height: 100%; background: #00f0ff; border-radius: 5px; transition: width 0.5s ease;"></div>
    </div>
  </div>

  <a-scene embedded style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;">
    <a-assets>
      <video id="bgvideo" autoplay loop muted crossorigin="anonymous" playsinline></video>
    </a-assets>
    <a-sky id="background" src="#bgvideo" rotation="0 0 0" material="shader: flat;"></a-sky>
    <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>
  </a-scene>

  <div id="chat-history">
    <h3>TiffyAI Chat</h3>
  </div>

  <div id="mainUI">
    <input type="text" id="messageBox" class="glass-input" placeholder="Ask Tiffy a question...">
    <div style="display:flex;">
      <button id="sendButton">Send</button>
      <button id="micButton" onclick="startMic()">
        <img src="https://ipfs.io/ipfs/QmTf2Zt1X1W2W9b7z5C5Q7H8E5X2K1J1T5P8b2M7S9" style="width: 20px; vertical-align: middle;">
      </button>
    </div>
  </div>

  <script>
    let loadingTimer;
    let userName = localStorage.getItem('tiffy_user_name');
    let aiName = "TiffyAI";

    document.getElementById("loadingStatus").innerText = `Waking up ${aiName}...`;

    function hideLoadingScreen() {
      const loadingScreen = document.getElementById("loadingScreen");
      loadingScreen.style.opacity = "0";
      setTimeout(() => { loadingScreen.style.display = "none"; }, 1000);
      document.body.style.overflow = "auto";
      if (!userName) {
        speak("Hello, I am Tiffy. What is your name?");
      } else {
        speak(`Welcome back, ${userName}. How can I help you today?`);
      }
    }

    // Set a timeout for the loading screen in case of a slow connection
    loadingTimer = setTimeout(hideLoadingScreen, 5000);

    window.onload = function() {
      document.getElementById("loadingProgress").style.display = "none";
      setTimeout(() => {
        document.getElementById("loadingStatus").innerText = "Tiffyverse is live.";
        clearTimeout(loadingTimer);
        setTimeout(hideLoadingScreen, 1500);
      }, 500);
    };

    // Modified speak function to handle links
    function speak(text) {
        // Create an element to contain the message
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('chat-message', 'ai');

        // Check for and replace with clickable links
        const linkRegex = /\/g;
        let processedText = text.replace(linkRegex, (match, url) => {
            return `<a href="${url}" target="_blank" style="color: #00f0ff; text-decoration: underline;">${url}</a>`;
        });

        // Add the message to the chat history
        messageContainer.innerHTML = `${aiName}: ${processedText}`;
        const history = document.getElementById('chat-history');
        history.appendChild(messageContainer);
        history.scrollTop = history.scrollHeight;

        // Speak the text content only
        const speech = new SpeechSynthesisUtterance(text.replace(linkRegex, ''));
        speech.volume = 1;
        speech.rate = 1.2;
        speech.pitch = 1;
        window.speechSynthesis.speak(speech);
    }
    
    // Original addMessageToHistory function for user messages
    function addMessageToHistory(sender, message, type) {
      const history = document.getElementById('chat-history');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('chat-message', type);
      messageDiv.textContent = `${sender}: ${message}`;
      history.appendChild(messageDiv);
      history.scrollTop = history.scrollHeight;
    }

    function setVideo(url) {
      const video = document.getElementById("bgvideo");
      if (!video) return;
      if (url.endsWith(".mp4") || url.endsWith(".webm")) {
        video.src = url;
        try { video.load(); video.play(); } catch(e){}
        document.querySelector("#background").setAttribute("src", "#bgvideo");
      } else {
        document.querySelector("#background").setAttribute("src", url);
      }
    }

    /***********************
     * Microphone STT
     ***********************/
    function startMic() {
      try {
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Recognition) { speak("Sorry, speech recognition isn't supported in your browser."); return; }
        const recognition = new Recognition();
        recognition.lang = "en-US";
        recognition.start();
        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('messageBox').value = transcript;
          sendMessage();
        };
      } catch (e) {
        speak("Microphone access failed.");
      }
    }

    // Enter-to-send
    document.getElementById('messageBox').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // cold start: if userName present, adjust UI
    if (userName) {
      document.getElementById("userName").style.display = "none";
      document.getElementById("changeName").style.display = "inline-block";
    }

    /***********************
     * TiffyAI Conversational Logic
     ***********************/

    // Load knowledge base from the JSON file
    let knowledgeBase = [];
    let conversationMemory = {
        lastTopic: null,
        lastLinkHint: null,
        lastCommand: null,
        history: []
    };

    fetch('knowledge.json')
      .then(response => response.json())
      .then(data => {
        knowledgeBase = data;
        console.log("Knowledge base loaded successfully.");
      })
      .catch(error => {
        console.error("Error loading knowledge.json:", error);
      });

    // Helper function to process responses with placeholders
    function processResponse(response, memory) {
        let processedResponse = response;
        if (memory.lastTopic) {
            processedResponse = processedResponse.replace(/{lastTopic}/g, memory.lastTopic);
        }
        if (memory.lastLinkHint) {
            processedResponse = processedResponse.replace(/{lastLinkHint}/g, memory.lastLinkHint);
        }
        if (memory.lastCommand) {
            processedResponse = processedResponse.replace(/{lastCommand}/g, memory.lastCommand);
        }
        return processedResponse;
    }

    // New sendMessage logic
    function sendMessage() {
      const messageBox = document.getElementById('messageBox');
      const message = messageBox.value.toLowerCase().trim();
      if (!message) return;

      addMessageToHistory(userName || 'User', message, 'user');
      
      // Add user message to history
      conversationMemory.history.push({ type: 'user', text: message });
      if (conversationMemory.history.length > 10) {
        conversationMemory.history.shift(); // Keep history to last 10 turns
      }

      // Handle "yes" and "no" special cases first
      if (message === 'yes' && conversationMemory.history.length > 1) {
          const lastBotMessage = conversationMemory.history[conversationMemory.history.length - 2].textContent.toLowerCase();
          
          if (lastBotMessage.includes("guide you step by step")) {
              speak("Perfect. First, connect your wallet to the ecosystem through the wallet connect link.");
              messageBox.value = '';
              return;
          } else if (lastBotMessage.includes("try it for you")) {
              speak("Okay, here we go. The system is executing the command now...");
              messageBox.value = '';
              return;
          } else if (lastBotMessage.includes("prove it")) {
              speak("Watch this: It's all about seamless transactions.");
              messageBox.value = '';
              return;
          }
      } else if (message === 'no') {
          // Fallback logic for "no"
          speak("Alright, no pressure. Let me know if you change your mind.");
          messageBox.value = '';
          return;
      }

      // Check for keyword matches in the knowledge base
      let matchedResponse = null;
      let matchedEntry = null;

      for (const entry of knowledgeBase) {
        const keywords = entry.keywords.map(k => k.toLowerCase());
        if (keywords.some(keyword => message.includes(keyword))) {
          matchedEntry = entry;
          
          if (entry.contextual && conversationMemory.lastTopic) {
            const randomIndex = Math.floor(Math.random() * entry.responses[0].length);
            matchedResponse = processResponse(entry.responses[0][randomIndex], conversationMemory);
          } else if (!entry.contextual) {
             const randomIndex = Math.floor(Math.random() * entry.responses[0].length);
             matchedResponse = entry.responses[0][randomIndex];
             
             // Update memory for non-contextual keywords
             if (entry.memoryUsage) {
                if (entry.memoryUsage === 'lastTopic') {
                    // Assuming the response will set the new topic
                    // You might need to manually set this in a more complex setup
                    // For now, let's derive it from the matched entry
                    conversationMemory.lastTopic = entry.keywords[0]; 
                    conversationMemory.lastLinkHint = "the website link"; 
                    conversationMemory.lastCommand = "say 'play game'"; 
                }
             }
          }
          break; // Exit loop after first match
        }
      }

      // Fallback if no keyword is found
      if (matchedResponse === null) {
          const fallbackEntry = knowledgeBase.find(e => e.keywords.includes("fallback"));
          if (fallbackEntry) {
              const randomIndex = Math.floor(Math.random() * fallbackEntry.responses[0].length);
              matchedResponse = fallbackEntry.responses[0][randomIndex];
          } else {
              matchedResponse = "I'm not sure I understand that. Can you rephrase?";
          }
      }

      // Speak the final response
      speak(matchedResponse);
      messageBox.value = '';
    }

    // Attach the new sendMessage to the button click and enter key events
    document.getElementById('sendButton').onclick = sendMessage;
    document.getElementById('messageBox').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

  </script>
</body>
</html>
