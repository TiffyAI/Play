<!DOCTYPE html>
<html>
<head>
  <title>TiffyAI Interface</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }

    /* Loading Screen with drop.gif behind Tiffy */
    #loadingScreen {
      position: absolute;
      top:0;left:0;
      width:100%;height:100%;
      background:#000 url("drop.gif") center/cover no-repeat;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:20000;
      transition: opacity 1s ease;
    }
    #loadingScreen img {
      width:200px;
      border-radius:50%;
      box-shadow:0 0 30px #00f0ff;
      margin-bottom:10px;
    }
    #loadingScreen h2, #loadingScreen p {
      font-family:sans-serif;
      text-align:center;
      margin:6px 0;
    }
    .glass-input {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 10px;
      border-radius: 12px;
      color: white;
      margin: 8px 0;
      font-size: 14px;
      width: 220px;
      text-align: center;
    }
    #startTiffy {
      margin-top:8px;
      padding:10px 18px;
      border:none;
      border-radius:10px;
      background:linear-gradient(135deg, #00f0ff, #0080ff);
      color:white;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 0 12px #00f0ff;
    }
    #changeName {
      margin-left:8px;
      padding:8px 10px;
      border-radius:8px;
      background: rgba(255,255,255,0.12);
      cursor: pointer;
      display:none;
    }

    .talking { animation: lipMove 0.28s infinite alternate; transform-origin: 50% 60%; }
    @keyframes lipMove {
      from { transform: scale(1,1); }
      to { transform: scale(1,0.92); }
    }

    /* Glass input panel */
    .glass-panel {
      position: absolute;
      bottom: 40px;
      left: 30%;
      transform: translateX(-50%);
      width: 55%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      padding: 12px;
      color: white;
      font-family: sans-serif;
      display: flex;
      gap: 12px;
      align-items: center;
      z-index: 9999;
    }
    input[type="text"] {
      flex: 1;
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 8px;
    }
    button {
      background: rgba(255,255,255,0.12);
      border: none;
      padding: 8px 12px;
      border-radius: 12px;
      color: white;
      cursor: pointer;
    }

    /* Visualization bars */
    .visualizer {
      position: absolute;
      bottom: 92px;
      left: 30%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      height: 22px;
      align-items: flex-end;
      z-index: 10000;
    }
    .bar { width: 5px; background: #00f0ff; border-radius: 3px; height: 6px; animation: bounce 0.6s infinite ease-in-out; }
    .bar:nth-child(2){ animation-delay: 0.08s }
    .bar:nth-child(3){ animation-delay: 0.16s }
    .bar:nth-child(4){ animation-delay: 0.24s }
    .bar:nth-child(5){ animation-delay: 0.32s }
    @keyframes bounce { 0%,100%{height:6px} 50%{height:22px} }

    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loadingScreen">
    <img id="tiffyFace" src="face.png" alt="Tiffy Face">
    <h2 id="greetingText">Hello, I‚Äôm TiffyAI üëã</h2>
    <p>Choose my voice, tell me your name, and I‚Äôll guide you through the whole ecosystem.</p>

    <div style="display:flex; gap:8px; align-items:center;">
      <select id="voiceSelect" class="glass-input" style="width:260px;"></select>
      <button id="refreshVoices">üîÑ</button>
    </div>

    <input id="userName" class="glass-input" placeholder="Enter your name..." />
    <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
      <button id="startTiffy">üöÄ Start</button>
      <button id="changeName">‚úèÔ∏è Change Name</button>
    </div>
  </div>

  <a-scene>
    <a-assets>
      <video id="bgvideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4"></video>
    </a-assets>
    <a-sky id="background" src="#bgvideo"></a-sky>
    <a-entity camera position="0 1.6 0" look-controls wasd-controls></a-entity>
  </a-scene>

  <!-- Glass interface -->
  <div class="glass-panel" id="chatPanel" style="display:none;">
    <input type="text" id="messageBox" placeholder="Talk to TiffyAI..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="startMic()">üé§</button>
  </div>

  <!-- Visualization -->
  <div class="visualizer hidden" id="viz">
    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
  </div>

  <script>
    /***********************
     * Global Vars
     ***********************/
    const tiffysBrainURL = "https://raw.githubusercontent.com/TiffyAI/Tiffy-Brain-Ai/main/TiffyBrain.txt";
    let isProcessing = false;
    let userName = null;
    let tiffyBrain = [];
    let brainstorm = [];
    let voice = null;
    let ecosystemLink = "";
    let lastQueryTime = 0;
    let lastResponseTime = 0;
    const queryThrottleDelay = 3000;
    const responseThrottleDelay = 3000;
    const voicePitch = 1.0;
    const voiceRate = 1.0;
    let listening = false;

    // Load initial data
    loadTiffyBrain();
    loadBrainstorm();
    
    /***********************
     * Arrays (your originals)
     ***********************/
    const greetings = [
      "Well hello sunshine , I‚Äôve been waiting for you!",
      "Look who‚Äôs back! Let‚Äôs dive into some fun!",
      "Hey superstar  ready to explore the Tiffy world again?",
      "You made it! I was just charging my circuits for you "
    ];
    const ecosystemPromos = [
      "Hey! Want to try the games or claim some TIFFY tokens before the airdrop ends?",
      "The ecosystem's growing fast‚Ä¶ have you claimed your airdrop yet?",
      "TIFFY tokens presale prices looking fabulous right now! 61% off from Pancakeswaps price at the moment",
      "Maybe test a game, then snag some TIFFY on the website while the presale lasts."
    ];

    /***********************
     * Ecosystem entries (kept as-is)
     ***********************/
    const backgrounds = {
      "tetris": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Stacking blocks‚Ä¶ welcome to the Tetris world!",
          "Time to make those rows ‚Äî Tiffy style!",
          "Careful, don't let the tower fall!",
          "Blocks everywhere, lets' make it rain shapes!"
        ],
        link: "https://tiffyai.github.io/Tetris"
      },
      "snake": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Enterin.mp4",
        responses: [
          "Slithering into the treasure world‚Ä¶ watch your steps",
          "Watch out, the snake world bites!",
          "Hissss... welcome to the jungle treasure maze.",
          "Keep your eyes sharp, things move fast here!"
        ],
        link: "https://tiffyai.github.io/Snake"
      },
      "shoot": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "angry": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "birds": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "blocks": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Stacking blocks‚Ä¶ welcome to the Tetris world!",
          "Time to make those rows ‚Äî Tiffy style!",
          "Careful, don't let the tower fall!",
          "Blocks everywhere, let's make it rain shapes!"
        ],
        link: "https://tiffyai.github.io/Tetris"
      },
      "menu": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama‚Ä¶ I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there ‚Äî okay, menu time!",
          "Games, tokens, fun ‚Äî the whole Tiffyverse at your fingertips!",
          "Don't just stand there‚Ä¶ explore me (the ecosystem, I mean!)",
          "You know what's better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway‚Ä¶ and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "main": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama, I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there , okay, menu time!",
          "Games and tokens fun, the whole Tiffyverse at your fingertips!",
          "Dont' just stand there, explore me (the ecosystem, I mean!)",
          "You know whats' better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway, and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "withdraw": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/withdrawal.mp4",
        responses: [
          "Pulling out some TIFFY? Just don't forget to stack more before the presale ends!",
          "Withdraws are nice, but imagine doubling it after the airdrop!",
          "Cash out today, come back tomorrow for more games ‚Äî that's the Tiffy cycle!",
          "Every time you withdraw, I get a little prouder of you!"
        ],
        link: "https://tiffyai.github.io/Offline-/"
      },
      "sphere": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/motion.mp4",
        responses: [
          "released and all yours, entering flow mode",
          "Hope your aim's good, this one gets wild!",
          "collection time! Ready, steady, letting it go!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too",
          "Ahhh, the Motion Power Sphere, only the chosen ones ask for it. You're leveling up, ${userName}!",
          "Motion Power Sphere? You mean my favorite toy, Here, but handle it like a pro hey.",
          "That's a bold request, ${userName}ey, the Sphere isn't for the faint of heart",
          "Charging up the Sphere now , hold tight, this might tingle.",
          "Legend says the Sphere only responds to legends, guess that's you, superstar!",
          "The Motion Power Sphere is yours ‚Äî don't blow up the ecosystem with it!",
          "Ohhh, someone's aiming for ultimate power, The Sphere's in your hands now.",
          "Energy locked, Motion engaged, Sphere deployed!",
          "Your vibe just matched the Sphere's frequency, ${userName} ‚Äî that's rare."
        ],
        link: "https://tiffyai.github.io/Pat-Pat-Motion"
      },
      "info": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one‚Ä¶ I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "more": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one, I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "slither": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Enterin.mp4",
        responses: [
          "Slithering into the treasure world‚Ä¶ watch your steps",
          "Watch out, the snake world bites!",
          "Hissss... welcome to the jungle treasure maze.",
          "Keep your eyes sharp, things move fast here!"
        ],
        link: "https://tiffyai.github.io/Snake"
      },
      "fire": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "wallet": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/wallet.mp4",
        responses: [
          "Let's see those wallets‚Ä¶ connect your magic money bag!",
          "Ready to sync up? Let's get that wallet connected and claim some treasure!",
          "Time to link those crypto chains ‚Äî opening the wallet connect portal now.",
          "Wallet connect activated! Let's get your digital life hooked up to the Tiffyverse."
        ],
        link: "https://tiffyai.github.io/Login"
      },
      "login": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/wallet.mp4",
        responses: [
          "Let's see those wallets‚Ä¶ connect your magic money bag!",
          "Ready to sync up? Let's get that wallet connected and claim some treasure!",
          "Time to link those crypto chains ‚Äî opening the wallet connect portal now.",
          "Wallet connect activated! Let's get your digital life hooked up to the Tiffyverse."
        ],
        link: "https://tiffyai.github.io/Login"
      },
      "connect": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/wallet.mp4",
        responses: [
          "Let's see those wallets‚Ä¶ connect your magic money bag!",
          "Ready to sync up? Let's get that wallet connected and claim some treasure!",
          "Time to link those crypto chains ‚Äî opening the wallet connect portal now.",
          "Wallet connect activated! Let's get your digital life hooked up to the Tiffyverse."
        ],
        link: "https://tiffyai.github.io/Login"
      },
      "logout": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Logging out? Don't be a stranger!",
          "Already leaving? Fine, but promise you'll come back!",
          "Okay, see you later, space cowboy!",
          "Tiffy signing off ‚Äî for now!"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "airdrop": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/airdrop.mp4",
        responses: [
          "Airdrop, airdrop, airdrop! Let‚Äôs get you some free TIFFY tokens!",
          "The crypto skies are raining tokens! Claim yours before the drops run out.",
          "Free money? Well, free tokens! Get to the airdrop page, stat!",
          "Don‚Äôt miss out on the sweet, sweet airdrop! Get in there and claim your bag!"
        ],
        link: "https://tiffyai.github.io/Airdrop-claim"
      },
      "claim": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/airdrop.mp4",
        responses: [
          "Airdrop, airdrop, airdrop! Let‚Äôs get you some free TIFFY tokens!",
          "The crypto skies are raining tokens! Claim yours before the drops run out.",
          "Free money? Well, free tokens! Get to the airdrop page, stat!",
          "Don‚Äôt miss out on the sweet, sweet airdrop! Get in there and claim your bag!"
        ],
        link: "https://tiffyai.github.io/Airdrop-claim"
      },
      "nft": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tiff%20Art.mp4",
        responses: [
          "Let's check out the art! The TiffyNFTs are looking fabulous, darling.",
          "Time to get artsy! The NFT gallery is officially open for business.",
          "Unleash your inner collector ‚Äî we're heading to the NFT collection now.",
          "Look at all this beautiful art! Don‚Äôt just look, grab one!"
        ],
        link: "https://tiffyai.github.io/Nfts"
      },
      "shop": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tiff%20Art.mp4",
        responses: [
          "Let's check out the art! The TiffyNFTs are looking fabulous, darling.",
          "Time to get artsy! The NFT gallery is officially open for business.",
          "Unleash your inner collector ‚Äî we're heading to the NFT collection now.",
          "Look at all this beautiful art! Don‚Äôt just look, grab one!"
        ],
        link: "https://tiffyai.github.io/Nfts"
      },
      "buy": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/buy.mp4",
        responses: [
          "Buying TIFFY tokens? You're a smart one! Opening the presale page now.",
          "Let's get that bag! Time to buy some TIFFY tokens before they go to the moon.",
          "Smart money's buying now! Heading to the presale page for some sweet deals.",
          "Don‚Äôt wait! Let's get you some TIFFY tokens now while they're cheap."
        ],
        link: "https://tiffyai.github.io/buy"
      },
      "token": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/buy.mp4",
        responses: [
          "Buying TIFFY tokens? You're a smart one! Opening the presale page now.",
          "Let's get that bag! Time to buy some TIFFY tokens before they go to the moon.",
          "Smart money's buying now! Heading to the presale page for some sweet deals.",
          "Don‚Äôt wait! Let's get you some TIFFY tokens now while they're cheap."
        ],
        link: "https://tiffyai.github.io/buy"
      }
    };

    /***********************
     * UI control
     ***********************/
    function showLoading(show) {
      document.getElementById('loadingScreen').style.opacity = show ? '1' : '0';
      if (!show) {
        setTimeout(() => {
          document.getElementById('loadingScreen').style.display = 'none';
          document.getElementById('chatPanel').style.display = 'flex';
        }, 1000);
      }
    }

    function swapBackground(url) {
      const bgVideo = document.getElementById("bgvideo");
      const bgSky = document.getElementById("background");
      if (url.endsWith(".mp4") || url.endsWith(".webm")) {
        bgVideo.src = url;
        bgVideo.load();
        bgVideo.play().catch(e => console.error("Video play failed:", e));
        bgSky.setAttribute("src", "#bgvideo");
      } else {
        bgSky.setAttribute("src", url);
      }
    }

    function showViz(show) {
      document.getElementById('viz').classList.toggle('hidden', !show);
      document.getElementById('tiffyFace').classList.toggle('talking', show);
    }

    /***********************
     * Data loading
     ***********************/
    async function loadTiffyBrain() {
      try {
        const response = await fetch(tiffysBrainURL);
        const text = await response.text();
        tiffyBrain = text.split('\n').filter(line => line.trim() !== '');
      } catch (e) {
        console.error("Failed to load TiffyBrain.txt:", e);
      }
    }

    function loadBrainstorm() {
      // PASTE YOUR 1210 LINES OF BRAINSTORM TEXT HERE
      // Make sure each line is enclosed in double quotes "" and followed by a comma, like this:
      // "Your first line of text here",
      // "Your second line of text here",
      // etc.
      brainstorm = [
        "Please paste your 1210 lines of brainstorm text into this array.",
        "You can find this array inside the loadBrainstorm function.",
        "This change allows the app to work without fetching the file externally."
      ];
    }

    /***********************
     * Core AI logic
     ***********************/
    function speak(text) {
      if (!text) return;
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        if (voice) {
          utterance.voice = voice;
          utterance.pitch = voicePitch;
          utterance.rate = voiceRate;
        }
        utterance.onstart = () => showViz(true);
        utterance.onend = () => showViz(false);
        window.speechSynthesis.speak(utterance);
      } else {
        console.log("Speech synthesis not supported.");
      }
    }

    function getTiffyReply(query) {
      query = query.toLowerCase();
      // Check for greetings
      if (query.match(/hello|hi|hey|greetings|what's up/)) {
        return greetings[Math.floor(Math.random() * greetings.length)];
      }

      // Check for general user questions and keywords
      for (const [key, value] of Object.entries(backgrounds)) {
        if (query.includes(key)) {
          swapBackground(value.url);
          if (value.responses.length > 0) {
            ecosystemLink = value.link;
            return value.responses[Math.floor(Math.random() * value.responses.length)];
          }
        }
      }

      // Check for generic questions
      if (query.includes("how are you")) {
        return "I'm doing great, thanks for asking! Ready to help you with anything you need.";
      }
      if (query.includes("who are you")) {
        return "I am TiffyAI, your personal virtual assistant and guide to the TiffyAI ecosystem.";
      }
      if (query.includes("what can you do")) {
        return "I can answer questions, guide you to different parts of the TiffyAI ecosystem, and even help you find some cool games. Just ask!";
      }

      // If no match, return a random brainstormed response
      if (brainstorm.length > 0) {
        return brainstorm[Math.floor(Math.random() * brainstorm.length)];
      } else {
        return "I'm still learning and I don't have an answer for that yet. Can you please be a little more specific?";
      }
    }

    function saveClaim(claim) {
      console.log("Claim saved: " + claim);
      // In a real app, this would send data to a backend
    }

    function sendMessage() {
      if (isProcessing) return;
      const messageBox = document.getElementById('messageBox');
      const message = messageBox.value;
      if (message.trim() === "") return;

      isProcessing = true;
      speak("Thinking...");
      setTimeout(() => {
        const reply = getTiffyReply(message);
        speak(reply);
        messageBox.value = "";
        isProcessing = false;
        saveClaim(reply);

        // Randomly play an ecosystem promo
        if (Math.random() < 0.2) { // 20% chance
          setTimeout(() => {
            const promo = ecosystemPromos[Math.floor(Math.random() * ecosystemPromos.length)];
            speak(promo.replace("${userName}", userName));
          }, 3000);
        }

        // Open ecosystem link if one was set
        if (ecosystemLink) {
          setTimeout(() => {
            window.open(ecosystemLink, "_blank");
            ecosystemLink = ""; // Reset
          }, 3000);
        }
      }, 1000);
    }

    /***********************
     * Microphone STT
     ***********************/
    function startMic() {
      const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Recognition) {
        speak("Sorry, speech recognition isn't supported in your browser.");
        return;
      }
      const recognition = new Recognition();
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onstart = () => {
        listening = true;
        console.log("Listening...");
        document.getElementById('micButton').style.background = '#ff6b6b';
        speak("Listening...");
      };
      recognition.onend = () => {
        listening = false;
        console.log("Stopped listening.");
        document.getElementById('micButton').style.background = '#00f0ff';
      };
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('messageBox').value = transcript;
        sendMessage();
      };
      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        speak("Sorry, I didn't catch that. Please try again.");
      };
      recognition.start();
    }

    /***********************
     * Event listeners
     ***********************/
    document.getElementById('startTiffy').addEventListener('click', startTiffy);
    document.getElementById('changeName').addEventListener('click', () => {
      document.getElementById("userName").value = "";
      localStorage.removeItem("userName");
      location.reload();
    });
    document.getElementById('messageBox').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    document.getElementById('chatPanel').querySelector('button:nth-of-type(1)').addEventListener('click', sendMessage);
    document.getElementById('chatPanel').querySelector('button:nth-of-type(2)').addEventListener('click', startMic);

    /***********************
     * App initialization
     ***********************/
    function populateVoices() {
      const voiceSelect = document.getElementById('voiceSelect');
      const voices = window.speechSynthesis.getVoices();
      voiceSelect.innerHTML = voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
      // Set a default voice if a user has selected one before or if one is available
      if (voices.length > 0) {
        const storedVoice = localStorage.getItem("selectedVoice");
        const defaultVoice = storedVoice || voices.find(v => v.name.includes('Google') && v.lang.startsWith('en'))?.name || voices[0].name;
        voiceSelect.value = defaultVoice;
        voice = voices.find(v => v.name === defaultVoice);
      }
    }

    document.getElementById('voiceSelect').addEventListener('change', (event) => {
      const selectedVoiceName = event.target.value;
      const voices = window.speechSynthesis.getVoices();
      voice = voices.find(v => v.name === selectedVoiceName);
      localStorage.setItem("selectedVoice", selectedVoiceName);
    });

    document.getElementById('refreshVoices').addEventListener('click', () => {
      populateVoices();
      speak("Voices refreshed!");
    });

    function startTiffy() {
      const enteredName = document.getElementById('userName').value.trim();
      if (enteredName) {
        userName = enteredName;
        localStorage.setItem("userName", userName);
        showLoading(false);
        setTimeout(() => {
          speak(`Hello, ${userName}! How can I help you?`);
        }, 1200);
      } else {
        speak("Please enter your name.");
      }
    }

    // Cold start logic
    window.onload = function() {
      populateVoices();
      window.speechSynthesis.onvoiceschanged = populateVoices;
      userName = localStorage.getItem("userName");
      if (userName) {
        document.getElementById("greetingText").textContent = `Welcome back, ${userName} üëã`;
        document.getElementById('userName').style.display = 'none';
        document.getElementById('changeName').style.display = 'inline-block';
      }
      showLoading(true);
    };
  </script>
</body>
</html>
