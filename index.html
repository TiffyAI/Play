<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TiffyAI</title>
  <style>
    body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:sans-serif}
    #loadingScreen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#111;z-index:10;transition:opacity .8s}
    #chatPanel{position:fixed;bottom:0;left:0;width:100%;height:40%;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);display:none;flex-direction:column;z-index:5}
    #messages{flex:1;overflow-y:auto;padding:10px}
    #inputPanel{display:flex}
    #messageBox{flex:1;padding:8px;font-size:16px}
    button{padding:8px;margin:4px}
    #viz{height:40px;background:#0f0;transition:opacity .3s;opacity:.8}
    #viz.hidden{opacity:0}
    #tiffyFace{position:absolute;top:10%;left:50%;transform:translateX(-50%);font-size:64px;transition:transform .3s}
    #tiffyFace.talking{transform:translateX(-50%) scale(1.2)}
    #background{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1}
    #voiceSelect{margin-left:10px}
  </style>
</head>
<body>
  <div id="loadingScreen"><div><h2 id="greetingText">Loading TiffyAI...</h2><input type="text" id="userName" placeholder="Enter your name"/><button id="startTiffy">Start</button><button id="changeName" style="display:none;">Change Name</button><button id="refreshVoices">Refresh Voices</button><select id="voiceSelect"></select></div></div>
  <div id="chatPanel"><div id="messages"></div><div id="inputPanel"><input id="messageBox" type="text" placeholder="Type your message"/><button onclick="sendMessage()">Send</button><button onclick="startMic()">ðŸŽ¤</button></div></div>
  <div id="viz" class="hidden"></div><div id="tiffyFace">ðŸ˜Š</div>
  <video id="bgvideo" autoplay muted loop playsinline style="display:none"></video>
  <a-scene vr-mode-ui="enabled: false"><a-sky id="background" color="#000"></a-sky></a-scene>
  <script>
    const greetings=["Hey {name}! Ready to explore?","Hi {name}, letâ€™s dive into Tiffyâ€™s world!","Welcome back {name}, shall we continue?","Yo {name}, time for some crypto magic!","Hey hey {name}, glad youâ€™re here!"];
    const ecosystemPromos=[
      "Donâ€™t forget: 1 $TIFFY + 1 Blue Key every day for free!",
      "3 Blue Keys unlocks the Luck Wheel â€” spin for surprises!",
      "Collect 5 Blue Keys to start unlocking Hidden Treasure.",
      "10 Blue Keys can be swapped for 1 Gold Key + Treasure access.",
      "Stack 10 Gold Keys to join AI-Trading + Liquidity unlocks.",
      "Play games to multiply your rewards, itâ€™s way more fun!",
      "For a limited time: claim 1 TIFFY and get 2 back instantly!"
    ];

    const backgrounds={
      "lottery":{url:"media/lottery.mp4",link:"https://tiffyai.github.io/Play/lottery",responses:["Feeling lucky? Grab a ticket and letâ€™s roll!","Lottery time! Maybe todayâ€™s your jackpot."]},
      "mining":{url:"media/mining.mp4",link:"https://tiffyai.github.io/Play/mining",responses:["Your mining machine is waiting, letâ€™s power it up!","More hashpower, more fun â€” start mining now."]},
      "keys":{url:"media/keys.mp4",link:"https://tiffyai.github.io/Play/keys",responses:["Blue Keys and Gold Keys unlock treasure, games and boosts!","Collect Keys wisely â€” they open bigger rewards later."]},
      "games":{url:"media/games.mp4",link:"https://tiffyai.github.io/Play/games",responses:["Game time! Letâ€™s play and multiply your TIFFY.","New quests await â€” ready for the challenge?"]},
      "staking":{url:"media/staking.mp4",link:"https://tiffyai.github.io/Play/staking",responses:["Stake $TIFFY and watch it grow like magic.","Boost your liquidity â€” staking is live!"]},
      "nft":{url:"media/nft.mp4",link:"https://tiffyai.github.io/Play/nft",responses:["NFTs are coming â€” unique boosts for your journey.","Collectible power-ups are dropping soon!"]}
    };
    let selectedVoice=null,voiceReady=false;
    let userName=localStorage.getItem("tiffyUserName")||"";
    let history=JSON.parse(localStorage.getItem("tiffyMemory")||"[]");
    let lastBotClaim=localStorage.getItem("tiffyLastClaim")||"";
    function saveMemory(){localStorage.setItem("tiffyMemory",JSON.stringify(history));}
    function saveClaim(txt){lastBotClaim=txt||"";localStorage.setItem("tiffyLastClaim",lastBotClaim);}
    function nickname(name){if(!name)return"friend";if(Math.random()<.33)return name+"ey";return name;}

    function populateVoices(){const sel=document.getElementById("voiceSelect");const voices=speechSynthesis.getVoices()||[];sel.innerHTML="";for(let i=0;i<voices.length;i++){const v=voices[i];const opt=document.createElement("option");opt.value=i;opt.textContent=`${v.name} (${v.lang})`;sel.appendChild(opt);}if(voices.length>0){const idx=sel.selectedIndex>=0?sel.selectedIndex:0;sel.selectedIndex=idx;selectedVoice=voices[idx];}}
    function ensureVoicesLoad(t=3000){populateVoices();let waited=0;const iv=setInterval(()=>{const voices=speechSynthesis.getVoices();if(voices&&voices.length>0){populateVoices();clearInterval(iv);}waited+=200;if(waited>=t)clearInterval(iv);},200);}
    document.getElementById("refreshVoices").addEventListener("click",populateVoices);
    window.addEventListener("load",()=>{ensureVoicesLoad(2500);if(userName){document.getElementById("userName").style.display="none";document.getElementById("changeName").style.display="inline-block";const g=greetings[Math.floor(Math.random()*greetings.length)];document.getElementById("greetingText").innerText=g.replace("{name}",nickname(userName));}initKnowledge();});
    if(speechSynthesis.onvoiceschanged!==undefined){speechSynthesis.onvoiceschanged=populateVoices;}

    function speak(text,cb=null){const viz=document.getElementById("viz");const face=document.getElementById("tiffyFace");viz.classList.remove("hidden");if(face)face.classList.add("talking");if(!("speechSynthesis"in window)){setTimeout(()=>{viz.classList.add("hidden");if(face)face.classList.remove("talking");if(cb)cb();},800);return;}const msg=new SpeechSynthesisUtterance(text);msg.rate=1;msg.pitch=1;msg.volume=1;msg.lang="en-US";try{const voices=speechSynthesis.getVoices();const sel=document.getElementById("voiceSelect");if(sel&&sel.value!==undefined&&voices[sel.value])msg.voice=voices[sel.value];else if(selectedVoice)msg.voice=selectedVoice;}catch{}const words=(text||"").trim().split(/\s+/).filter(Boolean).length||1;const fallbackMs=Math.max(800,Math.min(10000,Math.round(words*160)))+800;let done=false;const finish=()=>{if(done)return;done=true;viz.classList.add("hidden");if(face)face.classList.remove("talking");if(cb)cb();};const fallback=setTimeout(finish,fallbackMs);msg.onend=()=>{clearTimeout(fallback);finish();};msg.onerror=()=>{clearTimeout(fallback);finish();};try{speechSynthesis.cancel();speechSynthesis.speak(msg);}catch{clearTimeout(fallback);finish();}}

    document.getElementById("startTiffy").addEventListener("click",()=>{const nameEl=document.getElementById("userName");const typed=(nameEl&&nameEl.value)?nameEl.value.trim():"";if(typed){userName=typed;localStorage.setItem("tiffyUserName",userName);nameEl.style.display="none";document.getElementById("changeName").style.display="inline-block";}const voices=speechSynthesis.getVoices();const sel=document.getElementById("voiceSelect");if(voices&&voices.length>0&&sel.selectedIndex>=0)selectedVoice=voices[sel.selectedIndex];else selectedVoice=null;voiceReady=true;const greet=greetings[Math.floor(Math.random()*greetings.length)];const pickName=userName?nickname(userName):null;const intro=userName?`${greet} Hello ${pickName}, Iâ€™ll guide you through the ecosystem.`:"Hey, type your name above and press Start again so I can guide you better.";speak(intro,()=>{if(userName){setTimeout(()=>{document.getElementById("loadingScreen").style.opacity="0";setTimeout(()=>{document.getElementById("loadingScreen").style.display="none";document.getElementById("chatPanel").style.display="flex";},800);},600);history.push({role:"tiffy",text:intro});saveMemory();}});});
    document.getElementById("changeName").addEventListener("click",()=>{document.getElementById("userName").style.display="inline-block";document.getElementById("userName").value=userName||"";document.getElementById("changeName").style.display="none";});

    const KNOWLEDGE_URL="https://tiffyai.github.io/Play/knowledge.json";
    const KNOW_CACHE_KEY="tiffyKnowledgeCache",KNOW_CACHE_AT="tiffyKnowledgeCacheAt",KNOW_TTL_MS=1000*60*60*24*7;
    let knowledge=[];
    function initKnowledge(){const now=Date.now();const cached=localStorage.getItem(KNOW_CACHE_KEY);if(cached){try{knowledge=JSON.parse(cached)||[]}catch{knowledge=[];}}fetchWithTimeout(KNOWLEDGE_URL,{cache:"no-cache"},4500).then(r=>r.ok?r.json():Promise.reject()).then(data=>{if(Array.isArray(data)){knowledge=data;localStorage.setItem(KNOW_CACHE_KEY,JSON.stringify(data));localStorage.setItem(KNOW_CACHE_AT,String(now));}}).catch(()=>{});}
    function fetchWithTimeout(url,opts={},t=5000){const c=new AbortController();const id=setTimeout(()=>c.abort(),t);return fetch(url,{...opts,signal:c.signal}).finally(()=>clearTimeout(id));}
    const norm=s=> (s||"").toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
    const lastNWords=(s,n=3)=>norm(s).split(" ").filter(Boolean).slice(-n);
    function scoreItem(item,msg,lastUser,lastClaim){let sc=0;const msgT=new Set(norm(msg).split(" ").filter(Boolean));const lastT=new Set(lastNWords(lastUser,3));const claimT=new Set(lastNWords(lastClaim,4));if(Array.isArray(item.keywords)){for(const k of item.keywords){const kk=norm(k);if(kk&&(msgT.has(kk)||lastT.has(kk)||claimT.has(kk)))sc+=3;}}const last3=lastNWords(lastUser,3).join(" ");if(last3){for(const p of(item.responses||[])){if(norm((p||[]).join(" ")).includes(last3)){sc+=4;break;}}}const lc=norm(lastClaim);if(lc){for(const p of(item.responses||[])){if(norm((p||[]).join(" ")).includes(lastNWords(lc,3).join(" "))){sc+=2;break;}}}return sc;}
    function pickKnowledgeReply(userMsg){if(!Array.isArray(knowledge)||!knowledge.length)return null;const lastUser=[...history].reverse().find(h=>h.role!=="tiffy")?.text||"";let best=null,bestScore=-1;for(const item of knowledge){const sc=scoreItem(item,userMsg,lastUser,lastBotClaim);if(sc>bestScore){bestScore=sc;best=item;}}if(!best||!Array.isArray(best.responses)||!best.responses.length)return null;const pair=best.responses[Math.floor(Math.random()*best.responses.length)];const nick=nickname(userName);const l1=(pair[0]||"").replace("${userName}",nick);const l2=(pair[1]||"").replace("${userName}",nick);const joiners=[`${l1} ${l2}`,`${l1} â€” ${l2}`,`${l1}. ${l2}`];let out=joiners[Math.floor(Math.random()*joiners.length)];if(/new game|try this|i can|let me|iâ€™ll|i will|let's/i.test(out))saveClaim(out.substring(0,160));return out;}

    function memorySmallTalk(){const recent=history.slice(-3).map(h=>`${h.role}: ${h.text}`).join(" | ")||"nothing yet";const promo=ecosystemPromos[Math.floor(Math.random()*ecosystemPromos.length)];const nick=nickname(userName)||"friend";const spunky=[`Oh ${nick}, I remember: ${recent}.`,`Haha ${nick}, that memoryâ€™s still fresh: ${recent}.`,`${nick}, you keep surprising me â€” earlier: ${recent}.`];return `${spunky[Math.floor(Math.random()*spunky.length)]} ${promo}`;}
    function smartReply(msg){const know=pickKnowledgeReply(msg);if(know)return know;return memorySmallTalk();}

    function sendMessage(){const box=document.getElementById("messageBox");const msg=(box.value||"").trim();if(!msg)return;box.value="";history.push({role:userName||"user",text:msg});saveMemory();let found=false;const low=msg.toLowerCase();for(const key in backgrounds){if(low.includes(key)){const arr=backgrounds[key].responses||[backgrounds[key].response];const reply=arr[Math.floor(Math.random()*arr.length)];swapBackground(backgrounds[key].url);speak(reply);history.push({role:"tiffy",text:reply});saveMemory();saveClaim(reply);setTimeout(()=>{try{window.open(backgrounds[key].link,"_blank");}catch{}},4000);found=true;break;}}if(found)return;const reply=smartReply(msg);speak(reply);history.push({role:"tiffy",text:reply});saveMemory();saveClaim(reply);}
    function swapBackground(url){const video=document.getElementById("bgvideo");if(!video)return;if(url.endsWith(".mp4")||url.endsWith(".webm")){video.src=url;try{video.load();video.play();}catch{}document.querySelector("#background").setAttribute("src","#bgvideo");}else{document.querySelector("#background").setAttribute("src",url);}}
    function startMic(){try{const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;if(!Rec){speak("Sorry, speech recognition isnâ€™t supported.");return;}const r=new Rec();r.lang="en-US";r.start();r.onresult=e=>{const t=e.results[0][0].transcript;document.getElementById("messageBox").value=t;sendMessage();};}catch{ speak("Microphone access failed.");}}
    document.getElementById("messageBox").addEventListener("keydown",e=>{if(e.key==="Enter")sendMessage();});
    if(userName){document.getElementById("userName").style.display="none";document.getElementById("changeName").style.display="inline-block";}
  </script>
</body>
</html>
