<!DOCTYPE html>
<html>
<head>
  <title>TiffyAI Interface</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }

    /* Loading Screen with drop.gif behind Tiffy */
    #loadingScreen {
      position: absolute;
      top:0;left:0;
      width:100%;height:100%;
      background:#000 url("drop.gif") center/cover no-repeat;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:20000;
      transition: opacity 1s ease;
    }
    #loadingScreen img {
      width:200px;
      border-radius:50%;
      box-shadow:0 0 30px #00f0ff;
      margin-bottom:10px;
    }
    #loadingScreen h2, #loadingScreen p {
      font-family:sans-serif;
      text-align:center;
      margin:6px 0;
    }
    .glass-input {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 10px;
      border-radius: 12px;
      color: white;
      margin: 8px 0;
      font-size: 14px;
      width: 220px;
      text-align: center;
    }
    #startTiffy {
      margin-top:8px;
      padding:10px 18px;
      border:none;
      border-radius:10px;
      background:linear-gradient(135deg, #00f0ff, #0080ff);
      color:white;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 0 12px #00f0ff;
    }
    #changeName {
      margin-left:8px;
      padding:8px 10px;
      border-radius:8px;
      background: rgba(255,255,255,0.12);
      cursor: pointer;
      display:none;
    }

    .talking { animation: lipMove 0.28s infinite alternate; transform-origin: 50% 60%; }
    @keyframes lipMove {
      from { transform: scale(1,1); }
      to { transform: scale(1,0.92); }
    }

    /* Glass input panel */
    .glass-panel {
      position: absolute;
      bottom: 40px;
      left: 30%;
      transform: translateX(-50%);
      width: 55%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      padding: 12px;
      color: white;
      font-family: sans-serif;
      display: flex;
      gap: 12px;
      align-items: center;
      z-index: 9999;
    }
    input[type="text"] {
      flex: 1;
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 8px;
    }
    button {
      background: rgba(255,255,255,0.12);
      border: none;
      padding: 8px 12px;
      border-radius: 12px;
      color: white;
      cursor: pointer;
    }

    /* Visualization bars */
    .visualizer {
      position: absolute;
      bottom: 92px;
      left: 30%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      height: 22px;
      align-items: flex-end;
      z-index: 10000;
    }
    .bar { width: 5px; background: #00f0ff; border-radius: 3px; height: 6px; animation: bounce 0.6s infinite ease-in-out; }
    .bar:nth-child(2){ animation-delay: 0.08s }
    .bar:nth-child(3){ animation-delay: 0.16s }
    .bar:nth-child(4){ animation-delay: 0.24s }
    .bar:nth-child(5){ animation-delay: 0.32s }
    @keyframes bounce { 0%,100%{height:6px} 50%{height:22px} }

    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loadingScreen">
    <img id="tiffyFace" src="face.png" alt="Tiffy Face">
    <h2 id="greetingText">Hello, I‚Äôm TiffyAI üëã</h2>
    <p>Choose my voice, tell me your name, and I‚Äôll guide you through the whole ecosystem.</p>

    <div style="display:flex; gap:8px; align-items:center;">
      <select id="voiceSelect" class="glass-input" style="width:260px;"></select>
      <button id="refreshVoices">üîÑ</button>
    </div>

    <input id="userName" class="glass-input" placeholder="Enter your name..." />
    <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
      <button id="startTiffy">üöÄ Start</button>
      <button id="changeName">‚úèÔ∏è Change Name</button>
    </div>
  </div>

  <a-scene>
    <a-assets>
      <video id="bgvideo" autoplay loop muted playsinline src="https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4"></video>
    </a-assets>
    <a-sky id="background" src="#bgvideo"></a-sky>
    <a-entity camera position="0 1.6 0" look-controls wasd-controls></a-entity>
  </a-scene>

  <!-- Glass interface -->
  <div class="glass-panel" id="chatPanel" style="display:none;">
    <input type="text" id="messageBox" placeholder="Talk to TiffyAI..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="startMic()">üé§</button>
  </div>

  <!-- Visualization -->
  <div class="visualizer hidden" id="viz">
    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
  </div>

  <script>
    /***********************
     *  Arrays (your originals)
     ***********************/
    const greetings = [
      "Well hello sunshine , I‚Äôve been waiting for you!",
      "Look who‚Äôs back! Let‚Äôs dive into some fun!",
      "Hey superstar  ready to explore the Tiffy world again?",
      "You made it! I was just charging my circuits for you "
    ];
    const ecosystemPromos = [
      "Hey! Want to try the games or claim some TIFFY tokens before the airdrop ends?",
      "The ecosystem's growing fast‚Ä¶ have you claimed your airdrop yet?",
      "TIFFY tokens presale prices looking fabulous right now! 61% off from Pancakeswaps price at the moment",
      "Maybe test a game, then snag some TIFFY on the website while the presale lasts."
    ];

    /***********************
     * Ecosystem entries (kept as-is)
     ***********************/
    const backgrounds = {
      "tetris": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Stacking blocks‚Ä¶ welcome to the Tetris world!",
          "Time to make those rows ‚Äî Tiffy style!",
          "Careful, don't let the tower fall!",
          "Blocks everywhere, lets' make it rain shapes!"
        ],
        link: "https://tiffyai.github.io/Tetris"
      },
      "snake": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Enterin.mp4",
        responses: [
          "Slithering into the treasure world‚Ä¶ watch your steps",
          "Watch out, the snake world bites!",
          "Hissss... welcome to the jungle treasure maze.",
          "Keep your eyes sharp, things move fast here!"
        ],
        link: "https://tiffyai.github.io/Snake"
      },
      "shoot": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "angry": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "birds": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "blocks": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Stacking blocks‚Ä¶ welcome to the Tetris world!",
          "Time to make those rows ‚Äî Tiffy style!",
          "Careful, don't let the tower fall!",
          "Blocks everywhere, let's make it rain shapes!"
        ],
        link: "https://tiffyai.github.io/Tetris"
      },
      "menu": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama‚Ä¶ I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there ‚Äî okay, menu time!",
          "Games, tokens, fun ‚Äî the whole Tiffyverse at your fingertips!",
          "Don't just stand there‚Ä¶ explore me (the ecosystem, I mean!)",
          "You know what's better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway‚Ä¶ and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "main": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama, I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there , okay, menu time!",
          "Games and tokens fun, the whole Tiffyverse at your fingertips!",
          "Dont' just stand there, explore me (the ecosystem, I mean!)",
          "You know whats' better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway, and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "withdraw": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/withdrawal.mp4",
        responses: [
          "Pulling out some TIFFY? Just don't forget to stack more before the presale ends!",
          "Withdraws are nice, but imagine doubling it after the airdrop!",
          "Cash out today, come back tomorrow for more games ‚Äî that's the Tiffy cycle!",
          "Every time you withdraw, I get a little prouder of you!"
        ],
        link: "https://tiffyai.github.io/Offline-/"
      },
      "sphere": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/motion.mp4",
        responses: [
          "released and all yours, entering flow mode",
          "Hope your aim's good, this one gets wild!",
          "collection time! Ready, steady, letting it go!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too",
          "Ahhh, the Motion Power Sphere, only the chosen ones ask for it. You're leveling up, ${userName}!",
          "Motion Power Sphere? You mean my favorite toy, Here, but handle it like a pro hey.",
          "That's a bold request, ${userName}ey, the Sphere isn't for the faint of heart",
          "Charging up the Sphere now , hold tight, this might tingle.",
          "Legend says the Sphere only responds to legends, guess that's you, superstar!",
          "The Motion Power Sphere is yours ‚Äî don't blow up the ecosystem with it!",
          "Ohhh, someone's aiming for ultimate power, The Sphere's in your hands now.",
          "Energy locked, Motion engaged, Sphere deployed!",
          "Your vibe just matched the Sphere's frequency, ${userName} ‚Äî that's rare."
        ],
        link: "https://tiffyai.github.io/Pat-Pat-Motion"
      },
      "info": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one‚Ä¶ I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "more": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one, I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "slither": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Enterin.mp4",
        responses: [
          "Slithering into the treasure world‚Ä¶ watch your steps",
          "Watch out, the snake world bites!",
          "Hissss... welcome to the jungle treasure maze.",
          "Keep your eyes sharp, things move fast here!"
        ],
        link: "https://tiffyai.github.io/Snake"
      },
      "fire": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "pissed off": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "angry birds": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/shoot.mp4",
        responses: [
          "Locked and loaded‚Ä¶ entering battle mode",
          "Hope your aim's good, this one gets wild!",
          "Pew pew time! Ready, steady, fire!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too"
        ],
        link: "https://tiffyai.github.io/Angry-coins"
      },
      "rows": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Stacking blocks‚Ä¶ welcome to the Tetris world!",
          "Time to make those rows ‚Äî Tiffy style!",
          "Careful, don't let the tower fall!",
          "Blocks everywhere, let's make it rain shapes!"
        ],
        link: "https://tiffyai.github.io/Tetris"
      },
      "how": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama‚Ä¶ I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there ‚Äî okay, menu time!",
          "Games, tokens, fun ‚Äî the whole Tiffyverse at your fingertips!",
          "Don't just stand there‚Ä¶ explore me (the ecosystem, I mean!)",
          "You know what's better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway‚Ä¶ and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "gaming": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama, I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there , okay, menu time!",
          "Games and tokens fun, the whole Tiffyverse at your fingertips!",
          "Dont' just stand there, explore me (the ecosystem, I mean!)",
          "You know whats' better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway, and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "ecosystem": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama, I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there , okay, menu time!",
          "Games and tokens fun, the whole Tiffyverse at your fingertips!",
          "Dont' just stand there, explore me (the ecosystem, I mean!)",
          "You know whats' better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway, and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "games": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama, I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there , okay, menu time!",
          "Games and tokens fun, the whole Tiffyverse at your fingertips!",
          "Dont' just stand there, explore me (the ecosystem, I mean!)",
          "You know whats' better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway, and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "claim": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        responses: [
          "Back to home base? Fine, but only because you asked so sweetly!",
          "Running home to mama, I mean menu. Let's go!",
          "Ohhh I see‚Ä¶ someone's afraid of adventure. Menu loading!",
          "Pfft, already? You barely lasted out there , okay, menu time!",
          "Games and tokens fun, the whole Tiffyverse at your fingertips!",
          "Dont' just stand there, explore me (the ecosystem, I mean!)",
          "You know whats' better than playing games? Playing games *and* earning TIFFY!",
          "Every menu choice is a doorway, and some lead to treasure maps!",
          "The menu isn't just buttons ‚Äî it's basically a cheat code to the Tiffy multiverse!",
          "Quick question‚Ä¶ games first or do we go token hunting like a boss?",
          "The airdrop is still open, and rumor has it ${userName}ey, fast fingers win big!",
          "Psst‚Ä¶ PancakeSwap is looking mighty sweet right now, half-price TIFFY anyone?"
        ],
        link: "https://tiffyai.github.io/Dream-Menu"
      },
      "withdrawing": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/withdrawal.mp4",
        responses: [
          "Pulling out some TIFFY? Just don't forget to stack more before the presale ends!",
          "Withdraws are nice, but imagine doubling it after the airdrop!",
          "Cash out today, come back tomorrow for more games ‚Äî that's the Tiffy cycle!",
          "Every time you withdraw, I get a little prouder of you!"
        ],
        link: "https://tiffyai.github.io/Offline-/"
      },
      "cash out": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/withdrawal.mp4",
        responses: [
          "Pulling out some TIFFY? Just don't forget to stack more before the presale ends!",
          "Withdraws are nice, but imagine doubling it after the airdrop!",
          "Cash out today, come back tomorrow for more games ‚Äî that's the Tiffy cycle!",
          "Every time you withdraw, I get a little prouder of you!"
        ],
        link: "https://tiffyai.github.io/Offline-/"
      },
      "motion sphere": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/motion.mp4",
        responses: [
          "released and all yours, entering flow mode",
          "Hope your aim's good, this one gets wild!",
          "collection time! Ready, steady, letting it go!",
          "Careful ‚Äî sparks and feathers will fly in this arena! catch the coins too",
          "Ahhh, the Motion Power Sphere, only the chosen ones ask for it. You're leveling up, ${userName}!",
          "Motion Power Sphere? You mean my favorite toy, Here, but handle it like a pro hey.",
          "That's a bold request, ${userName}ey, the Sphere isn't for the faint of heart",
          "Charging up the Sphere now , hold tight, this might tingle.",
          "Legend says the Sphere only responds to legends, guess that's you, superstar!",
          "The Motion Power Sphere is yours ‚Äî don't blow up the ecosystem with it!",
          "Ohhh, someone's aiming for ultimate power, The Sphere's in your hands now.",
          "Energy locked, Motion engaged, Sphere deployed!",
          "Your vibe just matched the Sphere's frequency, ${userName} ‚Äî that's rare."
        ],
        link: "https://tiffyai.github.io/Pat-Pat-Motion"
      },
      "information": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one‚Ä¶ I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "learn": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one, I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "eloborate": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one, I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "explain": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one, I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "begin": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you, we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one, I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "start": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ready for the deep dive? Let's open up the vault ‚Äî socials, whitepaper, vision‚Ä¶ all the juicy bits about TiffyAI.",
          "Ooooh, curious type huh? Let me pull up the secrets of our world‚Ä¶ Facebook, Twitter, audits, all wrapped in one neat package.",
          "Info mode activated ‚Äî time to see how TiffyAI rolls behind the curtain. Come peek at the socials and whitepaper!",
          "So you want the backstory? Well, lucky you‚Ä¶ we've got socials, audits, and a vision that'll blow your mind. Opening it now.",
          "Heeey smart one, I knew you'd ask for this. The roadmap, socials, audit receipts, whitepaper ‚Äî all in one place. Let's go!",
          "Behind every cheeky AI is a solid foundation ‚Äî socials, Sourcify-verification, and the big vision. Opening intro page for you now.",
          "Want to know what makes me tick? Facebook, Twitter, whitepaper, and the master plan are all waiting in the intro link. Let's peek!",
          "Aha, info-hunter spotted, socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge."
        ],
        link: "https://tiffyai.github.io/Intro"
      },
      "telegram bot": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ohhh you wanna get closer to me? , Slide into my Telegram bot, darling.",
          "You know what,s better than chatting here? Talking to me directly on Telegram.",
          "Meet my sassier twin on Telegram",
          "Want me in your pocket 24,7? Hit up my bot.",
          "Careful, my Telegram bot is addictive, Don't say I didn't warn you",
          "Ready for the VIP lounge? Join me on Telegram",
          "Want to know what makes me tick? find my naughtier self here, look for AI",
          "Aha, info-hunter spotted, socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge. Say the word"
        ],
        link: "https://t.me/TiffyAI_Bot"
      },
      "telegram channel": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        responses: [
          "Ohhh you wanna get closer to me? Slide into my Telegram bot, darling.",
          "You know what's better than chatting here? Talking to me directly on Telegram.",
          "Meet my sassier twin on Telegram",
          "Want me in your pocket 24,7? Hit up my bot.",
          "Careful, my Telegram bot is addictive, Don't say I didn't warn you",
          "Ready for the VIP lounge? Join me on Telegram",
          "Want to know what makes me tick? find my naughtier self here, look for AI",
          "Aha, info-hunter spotted‚Ä¶ socials, audits, whitepaper, even the vision ‚Äî everything you need to flex your knowledge. Say the word"
        ],
        link: "https://t.me/TiffyAI_Bot"
      },
      "website": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/drop.gif",
        responses: [
          "Alright superstar, let's head to the official TiffyAI website. Time to see where the magic really happens.",
          "Taking you to the heart of TiffyAI. The official website is where the vision lives.",
          "You got it. Loading up the official TiffyAI home base for you right now.",
          "Boom. Straight to the source. Let's roll into the official TiffyAI website."
       ],
       link: "https://www.tiffyai.co.za"
      }
      };
/***********************
 * State & Memory
 ***********************/
let selectedVoice = null;
let voiceReady = false;
let userName = localStorage.getItem("tiffyUserName") || "";

// conversation memory + last bot claim for continuity
let history = JSON.parse(localStorage.getItem("tiffyMemory") || "[]");
let lastBotClaim = localStorage.getItem("tiffyLastClaim") || ""; // e.g., "new game: Starship TiffyAI"
function saveMemory() { localStorage.setItem("tiffyMemory", JSON.stringify(history)); }
function saveClaim(txt) { lastBotClaim = txt || ""; localStorage.setItem("tiffyLastClaim", lastBotClaim); }

// conversation context for knowledge templates (kept small & explicit)
const CTX_KEY = "tiffyLastContext";
let lastContext = (() => {
  try { return JSON.parse(localStorage.getItem(CTX_KEY) || "{}") || {}; }
  catch { return {}; }
})();
function saveContext() {
  localStorage.setItem(CTX_KEY, JSON.stringify(lastContext || {}));
}
function setContext(patch = {}) {
  lastContext = { ...(lastContext || {}), ...patch };
  saveContext();
}

// nickname helper
function nickname(name) {
  if (!name) return "friend";
  if (Math.random() < 0.33) return name + "ey";
  return name;
}

/***********************
 * Voice setup (silent)
 ***********************/
function populateVoices() {
  const select = document.getElementById("voiceSelect");
  const voices = speechSynthesis.getVoices() || [];
  select.innerHTML = "";
  for (let i = 0; i < voices.length; i++) {
    const v = voices[i];
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${v.name} (${v.lang})`;
    select.appendChild(opt);
  }
  if (voices.length > 0) {
    const idx = select.selectedIndex >= 0 ? select.selectedIndex : 0;
    select.selectedIndex = idx;
    selectedVoice = voices[idx];
  }
}
function ensureVoicesLoad(timeout = 3000) {
  populateVoices();
  let waited = 0;
  const iv = setInterval(() => {
    const voices = speechSynthesis.getVoices();
    if (voices && voices.length > 0) {
      populateVoices();
      clearInterval(iv);
    }
    waited += 200;
    if (waited >= timeout) clearInterval(iv);
  }, 200);
}
document.getElementById("refreshVoices").addEventListener("click", populateVoices);
window.addEventListener("load", () => {
  ensureVoicesLoad(2500);
  if (userName) {
    document.getElementById("userName").style.display = "none";
    document.getElementById("changeName").style.display = "inline-block";
    const g = greetings[Math.floor(Math.random() * greetings.length)];
    document.getElementById("greetingText").innerText = g.replace("{name}", nickname(userName));
  }
  initKnowledge(); // auto-refresh knowledge each session
  loadBrainstorm(); // load forward-thinking text answers
});
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = populateVoices;
}

/***********************
 * Speak with silent failover
 ***********************/
function speak(text, callback = null) {
  const viz = document.getElementById("viz");
  const face = document.getElementById("tiffyFace");
  viz.classList.remove("hidden");
  if (face) face.classList.add("talking");

  if (!('speechSynthesis' in window)) {
    setTimeout(() => {
      viz.classList.add("hidden");
      if (face) face.classList.remove("talking");
      if (callback) callback();
    }, 800);
    return;
  }

  const msg = new SpeechSynthesisUtterance(text);
  msg.rate = 1; msg.pitch = 1; msg.volume = 1; msg.lang = "en-US";
  try {
    const voices = speechSynthesis.getVoices();
    const sel = document.getElementById("voiceSelect");
    if (sel && sel.value !== undefined && voices[sel.value]) msg.voice = voices[sel.value];
    else if (selectedVoice) msg.voice = selectedVoice;
  } catch { }

  const wordCount = (text || "").trim().split(/\s+/).filter(Boolean).length || 1;
  const estimatedMs = Math.max(800, Math.min(10000, Math.round(wordCount * 160)));
  const fallbackMs = estimatedMs + 800;
  let done = false;
  const finish = () => {
    if (done) return; done = true;
    viz.classList.add("hidden");
    if (face) face.classList.remove("talking");
    if (callback) callback();
  };
  const fallback = setTimeout(finish, fallbackMs);
  msg.onend = () => { clearTimeout(fallback); finish(); };
  msg.onerror = () => { clearTimeout(fallback); finish(); };

  try { speechSynthesis.cancel(); speechSynthesis.speak(msg); }
  catch { clearTimeout(fallback); finish(); }
}

/***********************
 * Start button
 ***********************/
document.getElementById("startTiffy").addEventListener("click", () => {
  const nameEl = document.getElementById("userName");
  const typed = (nameEl && nameEl.value) ? nameEl.value.trim() : "";
  if (typed) {
    userName = typed;
    localStorage.setItem("tiffyUserName", userName);
    nameEl.style.display = "none";
    document.getElementById("changeName").style.display = "inline-block";
  }
  const voices = speechSynthesis.getVoices();
  const select = document.getElementById("voiceSelect");
  if (voices && voices.length > 0 && select.selectedIndex >= 0) {
    selectedVoice = voices[select.selectedIndex];
  } else { selectedVoice = null; }
  voiceReady = true;

  const greet = greetings[Math.floor(Math.random() * greetings.length)];
  const pickName = userName ? nickname(userName) : null;
  const introLine = userName
    ? `${greet} Hello ${pickName}, I‚Äôll guide you through the ecosystem.`
    : "Hey, I‚Äôd love to know your name so I can guide you better. Please type it in the name box above and press Start again.";

  speak(introLine, () => {
    if (userName) {
      setTimeout(() => {
        document.getElementById("loadingScreen").style.opacity = "0";
        setTimeout(() => {
          document.getElementById("loadingScreen").style.display = "none";
          document.getElementById("chatPanel").style.display = "flex";
        }, 800);
      }, 600);
      history.push({ role: "tiffy", text: introLine });
      saveMemory();
    }
  });
});

document.getElementById("changeName").addEventListener("click", () => {
  document.getElementById("userName").style.display = "inline-block";
  document.getElementById("userName").value = userName || "";
  document.getElementById("changeName").style.display = "none";
});

/***********************
 * Knowledge Engine (auto-refresh + cache + silent fallback)
 ***********************/
const KNOWLEDGE_URL = "https://tiffyai.github.io/Play/knowledge.json";
const KNOW_CACHE_KEY = "tiffyKnowledgeCache";
const KNOW_CACHE_AT = "tiffyKnowledgeCacheAt";
const KNOW_TTL_MS = 1000 * 60 * 60 * 24 * 7; // 7 days

let knowledge = []; // array of {keywords, personality, responses:[[line1,line2], ...], topic?, action?}

function initKnowledge() {
  const now = Date.now();
  const cached = localStorage.getItem(KNOW_CACHE_KEY);
  const cachedAt = parseInt(localStorage.getItem(KNOW_CACHE_AT) || "0", 10);
  if (cached) {
    try { knowledge = JSON.parse(cached) || []; } catch { knowledge = []; }
  }
  // refresh on each session (silent). If it fails, keep cache.
  fetchWithTimeout(KNOWLEDGE_URL, { cache: "no-cache" }, 4500)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      if (Array.isArray(data)) {
        knowledge = data;
        localStorage.setItem(KNOW_CACHE_KEY, JSON.stringify(data));
        localStorage.setItem(KNOW_CACHE_AT, String(now));
      }
    })
    .catch(() => { /* silent */ });

  // If no cache and fetch failed, keep empty -> engine will gracefully fallback.
}

function fetchWithTimeout(url, opts = {}, timeout = 5000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  return fetch(url, { ...opts, signal: controller.signal })
    .finally(() => clearTimeout(id));
}

// Simple normalization
function norm(s) { return (s || "").toLowerCase().replace(/[^a-z0-9\s]/g, " ").replace(/\s+/g, " ").trim(); }

// Extract last N words from a string
function lastNWords(s, n = 3) {
  const arr = norm(s).split(" ").filter(Boolean);
  return arr.slice(-n);
}

/***********************
 * brainstorm.txt (forward-thinking fallback with localStorage caching + safe fallback)
 ***********************/
const BRAIN_KEY = "tiffyBrainstormCache";
const BRAIN_AT = "tiffyBrainstormCacheAt";
const BRAIN_TTL_MS = 1000 * 60 * 60 * 24 * 30; // 30 days

let brainstormLines = [];

async function loadBrainstorm() {
  try {
    const now = Date.now();
    const cached = localStorage.getItem(BRAIN_KEY);
    const cachedAt = parseInt(localStorage.getItem(BRAIN_AT) || "0", 10);

    // ‚úÖ Use cache if valid
    if (cached && (now - cachedAt) < BRAIN_TTL_MS) {
      console.log("Loading brainstorm from localStorage cache.");
      brainstormLines = JSON.parse(cached) || [];
      return;
    }

    // ‚úÖ Otherwise fetch fresh, adding a timestamp to bust the cache.
    console.log("Fetching brainstorm.txt from server...");
    const cacheBusterUrl = `brainstorm.txt?v=${Date.now()}`;
    const res = await fetch(cacheBusterUrl, { cache: "no-cache" });
    if (!res.ok) {
      throw new Error(`HTTP error! Status: ${res.status}`);
    }
    const text = await res.text();

    brainstormLines = text.split("\n")
      .map(l => l.trim())
      .filter(Boolean);

    // ‚úÖ Try storing in localStorage (safe)
    try {
      localStorage.setItem(BRAIN_KEY, JSON.stringify(brainstormLines));
      localStorage.setItem(BRAIN_AT, String(now));
      console.log("Brainstorm loaded and cached successfully.");
    } catch (e) {
      console.warn("Brainstorm cache failed: File too large or other issue. Using session-only memory.", e);
      // Fallback: just keep in memory (no cache)
    }

  } catch (err) {
    console.warn("Brainstorm file not loaded:", err);
    brainstormLines = [];
  }
}

function brainstormReply(msg) {
  // Check if the brainstorm file has loaded and has content
  if (!brainstormLines.length) {
    console.warn("brainstormLines array is empty. Cannot find a reply from brainstorm.txt.");
    return null;
  }

  // Check if the user's message has at least 3 words
  const words = (msg || "").trim().split(/\s+/).filter(Boolean);
  if (words.length < 3) return null;
  const last3 = words.slice(-3).join(" ").toLowerCase();

  // Find a matching line
  for (const line of brainstormLines) {
    const lowerLine = line.toLowerCase();
    
    // Check if the line contains the last 3 words
    if (lowerLine.includes(last3)) {
      
      // Check for the specific response format.
      // This will use the line regardless of whether there is a space before the dots.
      if (line.endsWith(" ...") || line.endsWith("...")) {
        
        // Remove the dots and return the line.
        // It will remove the last 4 characters if there's a space, or 3 if there isn't.
        if (line.endsWith(" ...")) {
          return line.slice(0, -4);
        } else {
          return line.slice(0, -3);
        }
      }
    }
  }

  // No match found
  return null;
}

/***********************
 * Template resolver (no more {lastTopic} leaks)
 ***********************/
function resolveTemplate(text) {
  if (!text) return "";
  const map = {
    "{lastTopic}": lastContext?.lastTopic || "that",
    "{lastLinkHint}": lastContext?.lastLinkHint || "the right page",
    "{lastCommand}": lastContext?.lastCommand || "show me",
    "${userName}": nickname(userName || "friend"),
  };
  let out = text;
  for (const k in map) {
    out = out.split(k).join(map[k]);
  }
  // second pass: if something like {} remains, strip braces
  out = out.replace(/\{[^}]+\}/g, "").replace(/\s+/g, " ").trim();
  return out;
}

/***********************
 * Action pusher (open links / route to backgrounds)
 ***********************/
function tiffyPushCommand(action) {
  if (!action || !action.type) return;
  if (action.type === "link" && action.url) {
    // open after a short beat so speech can start
    setTimeout(() => { try { window.open(action.url, "_blank"); } catch (e) { } }, 600);
    setContext({ lastLinkHint: action.url, lastAction: "link" });
  } else if (action.type === "background" && action.key && backgrounds?.[action.key]) {
    const bg = backgrounds[action.key];
    swapBackground(bg.url);
    setContext({
      lastLinkHint: bg.link || "",
      lastAction: "background",
      lastTopic: action.key
    });
    if (bg.link) {
      setTimeout(() => { try { window.open(bg.link, "_blank"); } catch (e) { } }, 1200);
    }
  }
}

/***********************
 * Knowledge scoring + reply picker (with action + context)
 ***********************/
function scoreKnowledgeItem(item, msg, lastUser, lastClaim) {
  let score = 0;
  const msgTokens = new Set(norm(msg).split(" ").filter(Boolean));
  const lastTokens = new Set(lastNWords(lastUser, 3));
  const claimTokens = new Set(lastNWords(lastClaim, 4));

  if (Array.isArray(item.keywords)) {
    for (const k of item.keywords) {
      const kk = norm(k);
      if (kk && (msgTokens.has(kk) || lastTokens.has(kk) || claimTokens.has(kk))) score += 3;
    }
  }

  const last3 = lastNWords(lastUser, 3).join(" ");
  if (last3) {
    for (const pair of (item.responses || [])) {
      const joined = norm((pair || []).join(" "));
      if (joined.includes(last3)) { score += 4; break; }
    }
  }

  const lc = norm(lastClaim);
  if (lc) {
    for (const pair of (item.responses || [])) {
      const joined = norm((pair || []).join(" "));
      if (lc && joined.includes(lastNWords(lc, 3).join(" "))) { score += 2; break; }
    }
  }

  // tiny boost if item has an action (makes it more ‚Äúhelpful‚Äù)
  if (item.action && item.action.type) score += 1;

  return score;
}

function pickKnowledgeReply(userMsg) {
  if (!Array.isArray(knowledge) || knowledge.length === 0) return null;
  const lastUserTurn = [...history].reverse().find(h => h.role !== "tiffy")?.text || "";
  let best = null, bestScore = -1;

  for (const item of knowledge) {
    const sc = scoreKnowledgeItem(item, userMsg, lastUserTurn, lastBotClaim);
    if (sc > bestScore) { bestScore = sc; best = item; }
  }
  if (!best || !Array.isArray(best.responses) || best.responses.length === 0) return null;

  // assemble natural response (choose a pair)
  const pair = best.responses[Math.floor(Math.random() * best.responses.length)];
  const line1 = resolveTemplate(pair[0] || "");
  const line2 = resolveTemplate(pair[1] || "");
  let out = [line1, line2].filter(Boolean).join(" ");

  // context update: lastTopic from explicit topic or from a keyword hint
  const topicGuess = best.topic || (Array.isArray(best.keywords) ? best.keywords[0] : "");
  const linkHint = (best.action && best.action.url) ? best.action.url : (lastContext.lastLinkHint || "");
  setContext({
    lastTopic: topicGuess || lastContext.lastTopic || "",
    lastLinkHint: linkHint
  });

  // If the JSON item includes an action, execute it (and optionally add an acknowledgement)
  if (best.action && best.action.type) {
    tiffyPushCommand(best.action);
    // small, natural suffix acknowledging the action without relying on {lastCommand}
    if (best.action.type === "link") {
      out += " Opening it for you now.";
    } else if (best.action.type === "background") {
      out += " Loading it up ‚Äî you‚Äôre in!";
    }
  }

  // If this reply has any "promise-y" language, keep claim short
  if (/new game|try this|i can|let me|i‚Äôll|i will|let's/i.test(out)) {
    saveClaim(out.substring(0, 160));
  }
  return out;
}

/***********************
 * Fallback small talk using Brainstorm forward-thinking + promos
 ***********************/
function memorySmallTalk(msg) {
  // 1) Try Brainstorm forward-thinking line
  const b = brainstormReply(msg);
  if (b) return b;

  // 2) Spunky promo fallback (forward vibes, not lastTopic loops)
  const recent = history.slice(-3).map(h => `${h.role}: ${h.text}`).join(" | ") || "nothing yet";
  const promo = ecosystemPromos[Math.floor(Math.random() * ecosystemPromos.length)];
  const nick = nickname(userName) || "friend";
  const spunky = [
    `Oh ${nick}, that‚Äôs a fresh angle ‚Äî I like it.`,
    `Haha ${nick}, curveball received ‚Äî exploring that next.`,
    `${nick}, I love where your head‚Äôs at ‚Äî let‚Äôs make it fun.`
  ];
  const memoryLine = spunky[Math.floor(Math.random() * spunky.length)];
  return `${memoryLine} ${promo}`;
}

/***********************
 * Smart reply (keywords -> link/background, else knowledge -> brainstorm -> promos)
 ***********************/
function smartReply(userMsg) {
  // 1) Knowledge JSON
  const know = pickKnowledgeReply(userMsg);
  if (know) return know;

  // 2) Brainstorm + promos fallback
  return memorySmallTalk(userMsg);
}

/***********************
 * Send message handler
 ***********************/
function sendMessage() {
  const box = document.getElementById('messageBox');
  const msg = (box.value || "").trim();
  if (!msg) return;
  box.value = "";

  history.push({ role: userName || "user", text: msg });
  saveMemory();

  // Direct keyword routing (your backgrounds/links) ‚Äî UNTOUCHED
  let found = false;
  const msgLow = msg.toLowerCase();
  for (const key in backgrounds) {
    if (msgLow.includes(key)) {
      const arr = backgrounds[key].responses || [backgrounds[key].response];
      const reply = arr[Math.floor(Math.random() * arr.length)];
      swapBackground(backgrounds[key].url);
      speak(reply);
      history.push({ role: "tiffy", text: reply }); saveMemory();
      saveClaim(reply);

      // remember context when a direct command triggers
      setContext({
        lastTopic: key,
        lastLinkHint: backgrounds[key].link || "",
        lastAction: "background",
        lastCommand: key // helps templates, but never required
      });

      setTimeout(() => { try { window.open(backgrounds[key].link, "_blank"); } catch (e) { } }, 4000);
      found = true;
      break;
    }
  }
  if (found) return;

  // Otherwise use knowledge + brainstorm + promos
  const reply = smartReply(msg);
  speak(reply);
  history.push({ role: "tiffy", text: reply });
  saveMemory();
  saveClaim(reply);
}

/***********************
 * Background swap
 ***********************/
function swapBackground(url) {
  const video = document.getElementById("bgvideo");
  if (!video) return;
  if (url.endsWith(".mp4") || url.endsWith(".webm")) {
    video.src = url;
    try { video.load(); video.play(); } catch (e) { }
    document.querySelector("#background").setAttribute("src", "#bgvideo");
  } else {
    document.querySelector("#background").setAttribute("src", url);
  }
}

/***********************
 * Microphone STT
 ***********************/
function startMic() {
  try {
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!Recognition) { speak("Sorry, speech recognition isn't supported in your browser."); return; }
    const recognition = new Recognition();
    recognition.lang = "en-US";
    recognition.start();
    recognition.onresult = function (event) {
      const transcript = event.results[0][0].transcript;
      document.getElementById('messageBox').value = transcript;
      sendMessage();
    };
  } catch (e) {
    speak("Microphone access failed.");
  }
}

// Enter-to-send
document.getElementById('messageBox').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendMessage();
});

// cold start: if userName present, adjust UI
if (userName) {
  document.getElementById("userName").style.display = "none";
  document.getElementById("changeName").style.display = "inline-block";
}
</script>
</body>

</html>
