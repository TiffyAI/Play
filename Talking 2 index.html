<!DOCTYPE html>
<html>
<head>
  <title>TiffyAI Interface</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }

    /* Loading Screen */
    #loadingScreen {
      position: absolute;
      top:0;left:0;
      width:100%;height:100%;
      background:#111;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:20000;
      transition: opacity 1s ease;
    }
    #loadingScreen img {
      width:200px;
      border-radius:50%;
      box-shadow:0 0 30px #00f0ff;
      margin-bottom:20px;
    }
    #loadingScreen h2, #loadingScreen p {
      font-family:sans-serif;
      text-align:center;
    }
    #startTiffy {
      margin-top:15px;
      padding:12px 20px;
      border:none;
      border-radius:10px;
      background:linear-gradient(135deg, #00f0ff, #0080ff);
      color:white;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 0 15px #00f0ff;
    }
    .talking {
      animation: lipMove 0.3s infinite alternate;
    }
    @keyframes lipMove {
      from { transform: scale(1,1); }
      to { transform: scale(1,0.9); }
    }

    /* Glass input panel */
    .glass-panel {
      position: absolute;
      bottom: 40px;
      left: 30%;
      transform: translateX(-50%);
      width: 55%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 15px;
      color: white;
      font-family: sans-serif;
      display: flex;
      gap: 15px;
      align-items: center;
      z-index: 9999;
    }
    input {
      flex: 1;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 8px;
    }
    button {
      background: rgba(255,255,255,0.3);
      border: none;
      padding: 8px 12px;
      border-radius: 16px;
      color: white;
      cursor: pointer;
    }

    /* Visualization bars */
    .visualizer {
      position: absolute;
      bottom: 80px;
      left: 30%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      height: 20px;
      align-items: flex-end;
      z-index: 10000;
    }
    .bar {
      width: 4px;
      background: #00f0ff;
      border-radius: 2px;
      height: 5px;
      animation: bounce 0.6s infinite ease-in-out;
    }
    .bar:nth-child(2) { animation-delay: 0.1s; }
    .bar:nth-child(3) { animation-delay: 0.2s; }
    .bar:nth-child(4) { animation-delay: 0.3s; }
    .bar:nth-child(5) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 100% { height: 5px; }
      50% { height: 20px; }
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loadingScreen">
    <img src="face.png" alt="Tiffy Face">
    <h2>Hello, Iâ€™m TiffyAI ðŸ‘‹</h2>
    <p>Choose my voice, and I will guide you through the whole ecosystem.</p>
    <select id="voiceSelect"></select>
    <button id="startTiffy">ðŸš€ Start</button>
  </div>

  <a-scene>
    <a-assets>
      <video id="bgvideo" autoplay loop muted playsinline
        src="https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4">
      </video>
    </a-assets>
    <a-sky id="background" src="#bgvideo"></a-sky>
    <a-entity camera position="0 1.6 0" look-controls wasd-controls></a-entity>
  </a-scene>

  <!-- Glass interface -->
  <div class="glass-panel">
    <input type="text" id="messageBox" placeholder="Talk to TiffyAI..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="startMic()">ðŸŽ¤</button>
  </div>

  <!-- Visualization -->
  <div class="visualizer hidden" id="viz">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>

  <script>
    // Ecosystem structure (expandable)
    const backgrounds = {
      "tetris": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/Tetris%20Launch.mp4",
        response: "Stacking blocksâ€¦ welcome to the Tetris world!",
        link: "https://tiffyai.github.io/Play/Tetris"
      },
      "snake": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/play.mp4",
        response: "Slithering into the jungle worldâ€¦ watch your steps.",
        link: "https://tiffyai.github.io/Play/Snake"
      },
      "shoot": {
        url: "https://raw.githubusercontent.com/TiffyAI/Play/refs/heads/main/fin.mp4",
        response: "Locked and loadedâ€¦ entering battle mode.",
        link: "https://tiffyai.github.io/Play/Shoot"
      }
      // ðŸ”® add more here
    };

    let currentLink = null;
    let voiceReady = false;
    let selectedVoice = null;

    // Persistent memory store
    let history = JSON.parse(localStorage.getItem("tiffyMemory") || "[]");

    function saveMemory() {
      localStorage.setItem("tiffyMemory", JSON.stringify(history));
    }

    // Populate available voices
    function populateVoices() {
      let voices = speechSynthesis.getVoices();
      let select = document.getElementById("voiceSelect");
      select.innerHTML = "";
      voices.forEach((v, i) => {
        let opt = document.createElement("option");
        opt.value = i;
        opt.textContent = v.name + " (" + v.lang + ")";
        select.appendChild(opt);
      });
      select.onchange = () => { selectedVoice = voices[select.value]; };
      if (voices.length > 0) selectedVoice = voices[0];
    }
    speechSynthesis.onvoiceschanged = populateVoices;

    // Start button -> speak intro, THEN hide screen
    document.getElementById("startTiffy").addEventListener("click", () => {
      voiceReady = true;
      speak("Voice activated. Hello, Iâ€™m Tiffy. I will guide you through the ecosystem.", () => {
        document.getElementById("loadingScreen").style.opacity = "0";
        setTimeout(() => {
          document.getElementById("loadingScreen").style.display = "none";
        }, 1000);
      });
    });

    // Speak with visualization + avatar sync + callback
    function speak(text, callback=null) {
      if (!voiceReady || !('speechSynthesis' in window)) return;
      console.log("Tiffy says:", text);

      let msg = new SpeechSynthesisUtterance(text);
      msg.rate = 1;
      msg.pitch = 1;
      msg.lang = "en-US";
      if (selectedVoice) msg.voice = selectedVoice;

      let viz = document.getElementById("viz");
      viz.classList.remove("hidden");

      let face = document.querySelector("#loadingScreen img");
      if (face) face.classList.add("talking");

      msg.onend = () => {
        viz.classList.add("hidden");
        if (face) face.classList.remove("talking");
        if (callback) callback();
      };

      speechSynthesis.cancel();
      speechSynthesis.speak(msg);
    }

    // Handle send message
    function sendMessage() {
      let msg = document.getElementById('messageBox').value;
      if (!msg) return;
      console.log("User:", msg);
      history.push({role: "user", text: msg});
      saveMemory();

      let found = false;
      for (let keyword in backgrounds) {
        if (msg.toLowerCase().includes(keyword)) {
          swapBackground(backgrounds[keyword].url);
          speak(backgrounds[keyword].response);
          history.push({role: "tiffy", text: backgrounds[keyword].response});
          saveMemory();
          currentLink = backgrounds[keyword].link;

          setTimeout(() => {
            window.open(currentLink, "_blank");
          }, 4000);

          found = true;
          break;
        }
      }

      if (!found) {
        let reply = "I heard you say " + msg + ". Remember, my mission is to guide you through TiffyAI and promote the TiffyCoin ecosystem.";
        speak(reply);
        history.push({role: "tiffy", text: reply});
        saveMemory();
      }
    }

    // Swap video/image backgrounds
    function swapBackground(url) {
      let video = document.getElementById("bgvideo");
      if (url.endsWith(".mp4") || url.endsWith(".webm")) {
        video.src = url;
        video.load();
        video.play();
        document.querySelector("#background").setAttribute("src", "#bgvideo");
      } else {
        document.querySelector("#background").setAttribute("src", url);
      }
    }

    // Microphone input
    function startMic() {
      let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.start();
      recognition.onresult = function(event) {
        let transcript = event.results[0][0].transcript;
        document.getElementById('messageBox').value = transcript;
        sendMessage();
      }
    }
  </script>
</body>
</html>
